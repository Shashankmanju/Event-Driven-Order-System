# ğŸ›’ Order Management System - Complete Architecture Guide

> **A comprehensive guide explaining the end-to-end flow of order creation in a microservices architecture**

---

## ğŸ“‹ Table of Contents

- [Overview](#-overview)
- [System Architecture](#-system-architecture)
- [Complete Order Flow](#-complete-order-creation-flow)
- [Detailed Timeline](#-detailed-timeline)
- [Database State Changes](#-database-state-changes)
- [Order Cancellation](#-order-cancellation-flow)
- [Architecture Patterns](#-architecture-patterns-used)
- [Configuration](#-configuration-details)
- [Edge Cases](#-edge-cases-handled)

---

## ğŸ¯ Overview

This system demonstrates a **microservices-based order management system** using:

- **Two independent services**: Order Service and Product Service
- **Synchronous communication**: REST API for availability checks
- **Asynchronous communication**: Kafka for stock updates
- **Event-driven architecture**: Loosely coupled services

---

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MICROSERVICES ECOSYSTEM                       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   ORDER SERVICE      â”‚          â”‚  PRODUCT SERVICE     â”‚   â”‚
â”‚  â”‚   Port: 8082         â”‚â—„â”€â”€â”€RESTâ”€â”€â”‚  Port: 8051          â”‚   â”‚
â”‚  â”‚                      â”‚          â”‚                      â”‚   â”‚
â”‚  â”‚  â€¢ OrderController   â”‚          â”‚  â€¢ ProductController â”‚   â”‚
â”‚  â”‚  â€¢ OrderService      â”‚          â”‚  â€¢ ProductService    â”‚   â”‚
â”‚  â”‚  â€¢ OrderRepository   â”‚          â”‚  â€¢ ProductRepository â”‚   â”‚
â”‚  â”‚  â€¢ Kafka Producer    â”‚          â”‚  â€¢ Kafka Consumer    â”‚   â”‚
â”‚  â”‚                      â”‚          â”‚                      â”‚   â”‚
â”‚  â”‚  ğŸ“Š MySQL: orders    â”‚          â”‚  ğŸ“Š MySQL: inventory â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚                                  â”‚                â”‚
â”‚             â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚                â”‚
â”‚             â””â”€â”€â”€â”€â”€â–ºâ”‚ KAFKA BROKER  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                    â”‚  Port: 9092   â”‚                           â”‚
â”‚                    â”‚               â”‚                           â”‚
â”‚                    â”‚  Topics:      â”‚                           â”‚
â”‚                    â”‚  â€¢ order_placed                           â”‚
â”‚                    â”‚  â€¢ order_cancelled                        â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Services Overview**

| Service | Port | Database | Role |
|---------|------|----------|------|
| **Order Service** | 8082 | `orders` | Manages orders, publishes events |
| **Product Service** | 8051 | `inventory` | Manages products, consumes events |
| **Kafka Broker** | 9092 | - | Message broker for async communication |

---

## ğŸ”„ Complete Order Creation Flow

### **STEP 1: User Sends Order Request** ğŸ“¤

**User/Client makes HTTP request:**

```http
POST http://localhost:8082/api/orders/create
Content-Type: application/json

{
  "totalPrice": 1999.98,
  "orderDate": "2026-01-03T10:30:00",
  "orderItems": [
    {
      "skuCode": "LAPTOP-001",
      "productName": "Dell Laptop",
      "quantity": 2,
      "price": 999.99
    }
  ]
}
```

**What happens:**
- âœ… User submits order with product details
- âœ… Request reaches `OrderController.createOrder()`
- âœ… Order Service starts processing

---

### **STEP 2: Check Product Availability** ğŸ”

**Order Service validates stock with Product Service:**

```
ORDER SERVICE
    â”‚
    â”œâ”€â–º ProductServiceClient.checkProductAvailability()
    â”‚
    â””â”€â–º HTTP POST â†’ http://localhost:8051/api/products/availability
```

**Request to Product Service:**

```json
[
  {
    "skuCode": "LAPTOP-001",
    "quantity": 2
  }
]
```

**âš ï¸ CRITICAL: This is a SYNCHRONOUS call**
- Order Service **WAITS** for Product Service response
- **MUST** know availability before creating order
- Blocking operation (200-300ms)

---

### **STEP 3: Product Service Checks Database** ğŸ’¾

**Product Service flow:**

```
ProductController.checkProductAvailability()
    â”‚
    â”œâ”€â–º ProductService.checkProductAvailability()
    â”‚
    â”œâ”€â–º ProductRepository.findBySkuCode("LAPTOP-001")
    â”‚
    â””â”€â–º MySQL Query:
        SELECT * FROM products WHERE sku_code = 'LAPTOP-001'
```

**Availability Logic:**

```java
// Product in database
Product found: { skuCode: "LAPTOP-001", quantity: 50 }

// Requested quantity
Requested: 2

// Comparison
50 >= 2 ? âœ… YES â†’ available = true
```

**Response to Order Service:**

```json
{
  "productAvailabilityList": [
    {
      "skuCode": "LAPTOP-001",
      "available": true
    }
  ]
}
```

**ğŸš¨ IMPORTANT:** No stock is reduced yet! Only checking availability.

---

### **STEP 4: Order Service Processes Response** âœ…

**Order Service receives availability data:**

```java
// Filter only available items
List<OrderItemDto> availableItems = orderDto.getOrderItems()
    .filter(item -> isProductAvailable(item.getSkuCode(), availabilityList))
    .collect(Collectors.toList());

// Check if any items available
if (availableItems.isEmpty()) {
    âŒ return "No items available for order"
} else {
    âœ… continue with order creation
}
```

**Decision Tree:**

```
All products available?
    â”‚
    â”œâ”€â–º YES â†’ Continue to order creation
    â”‚
    â””â”€â–º NO â†’ Return error to user
```

---

### **STEP 5: Save Order to Database** ğŸ’¾

**Order Service persists order:**

```
OrderService.createOrder()
    â”‚
    â”œâ”€â–º Create Order entity
    â”‚   â€¢ totalPrice: 1999.98
    â”‚   â€¢ orderDate: 2026-01-03T10:30:00
    â”‚   â€¢ orderStatus: "ORDER_PLACED"
    â”‚
    â”œâ”€â–º Create OrderItem entities
    â”‚   â€¢ productId: "LAPTOP-001"
    â”‚   â€¢ quantity: 2
    â”‚   â€¢ price: 999.99
    â”‚
    â””â”€â–º OrderRepository.save(order)
```

**Database Operations:**

```sql
-- Insert order
INSERT INTO orders (total_price, order_date, order_status)
VALUES (1999.98, '2026-01-03 10:30:00', 'ORDER_PLACED');

-- Insert order items
INSERT INTO order_items (product_id, product_name, quantity, price, order_id)
VALUES ('LAPTOP-001', 'Dell Laptop', 2, 999.99, 1);
```

**Result:** Order ID = 1 created successfully! âœ…

---

### **STEP 6: Publish Event to Kafka** ğŸ“¨

**Order Service sends async event:**

```
OrderProducer.sendOrderEvent(orderDto, "placed")
    â”‚
    â”œâ”€â–º Topic: "order_placed"
    â”‚
    â””â”€â–º Message: {
            "id": 1,
            "totalPrice": 1999.98,
            "orderDate": "2026-01-03T10:30:00",
            "orderItems": [
              {
                "skuCode": "LAPTOP-001",
                "quantity": 2
              }
            ]
        }
```

**Kafka Broker:**

```
âœ… Message published to topic: order_placed
âœ… Partition: 0, Offset: 7
âœ… Event stored successfully
```

**âš¡ KEY POINT:** This is **ASYNCHRONOUS**
- Order Service doesn't wait for Product Service
- Event sits in Kafka queue
- Order Service continues to respond to user

---

### **STEP 7: Product Service Consumes Event** ğŸ“¥

**Kafka triggers Product Service consumer:**

```
@KafkaListener(topics = "order_placed")
ProductConsumer.consumeOrderPlaced()
    â”‚
    â”œâ”€â–º Deserialize JSON message
    â”‚
    â”œâ”€â–º Extract order items
    â”‚
    â””â”€â–º For each item:
            ProductService.reduceProductQuantity(skuCode, quantity)
```

**Stock Reduction Logic:**

```java
// Find product
Product product = productRepository.findBySkuCode("LAPTOP-001");
// Current: quantity = 50

// Check sufficient stock
if (product.getQuantity() >= 2) {
    // Calculate new quantity
    int newQuantity = 50 - 2 = 48;
    
    // Update product
    product.setQuantity(48);
    productRepository.save(product);
    
    âœ… Stock reduced successfully!
}
```

**Database Update:**

```sql
UPDATE products
SET quantity = 48
WHERE sku_code = 'LAPTOP-001';
```

**âœ… ACTUAL STOCK REDUCTION HAPPENS HERE**

---

### **STEP 8: Return Response to User** ğŸ“¬

**Order Service responds immediately:**

```http
HTTP/1.1 201 CREATED
Content-Type: application/json

{
  "orderId": 1,
  "status": "ORDER PLACED"
}
```

**âš¡ Performance Insight:**
- User gets response in ~300ms
- Stock reduction happens later (~500ms)
- User experience is fast!

---

## â±ï¸ Detailed Timeline

| Time | Service | Action | Type |
|------|---------|--------|------|
| **T+0ms** | Order Service | Receives POST request | Sync |
| **T+50ms** | Order Service | Calls Product Service REST API | Sync |
| **T+100ms** | Product Service | Checks availability in DB | Sync |
| **T+150ms** | Product Service | Returns availability response | Sync |
| **T+200ms** | Order Service | Filters available items | Sync |
| **T+250ms** | Order Service | Saves order to database | Sync |
| **T+300ms** | Order Service | Publishes event to Kafka | **Async** |
| **T+310ms** | Order Service | **Returns response to user** | Sync |
| **T+500ms** | Product Service | Consumes Kafka event | **Async** |
| **T+550ms** | Product Service | Reduces stock in database | **Async** |

**Total user-facing latency: ~310ms** âš¡

---

## ğŸ’¾ Database State Changes

### **Before Order Creation**

**Order Service Database (orders):**

```
orders table: EMPTY
order_items table: EMPTY
```

**Product Service Database (inventory):**

| id | name | skuCode | quantity | price |
|----|------|---------|----------|-------|
| 1 | Dell Laptop | LAPTOP-001 | **50** | 999.99 |

---

### **After Order Saved (Step 5)**

**Order Service Database (orders):**

**orders table:**

| id | total_price | order_date | order_status |
|----|-------------|------------|--------------|
| 1 | 1999.98 | 2026-01-03 10:30:00 | ORDER_PLACED |

**order_items table:**

| id | product_id | product_name | quantity | price | order_id |
|----|------------|--------------|----------|-------|----------|
| 1 | LAPTOP-001 | Dell Laptop | 2 | 999.99 | 1 |

**Product Service Database (inventory):**

| id | name | skuCode | quantity | price |
|----|------|---------|----------|-------|
| 1 | Dell Laptop | LAPTOP-001 | **50** âš ï¸ | 999.99 |

**âš ï¸ Stock NOT reduced yet!**

---

### **After Stock Reduction (Step 7)**

**Order Service Database:** *(No change)*

**Product Service Database (inventory):**

| id | name | skuCode | quantity | price |
|----|------|---------|----------|-------|
| 1 | Dell Laptop | LAPTOP-001 | **48** âœ… | 999.99 |

**âœ… Stock successfully reduced!**

---

## ğŸ”„ Order Cancellation Flow

### **Cancel Order Process**

```
USER
  â”‚
  â”‚ PUT http://localhost:8082/api/orders/cancel/1
  â”‚
  â–¼
ORDER SERVICE
  â”‚
  â”œâ”€â–º Find order by ID
  â”œâ”€â–º Update status to "ORDER_CANCELLED"
  â”œâ”€â–º Save to database
  â”‚
  â””â”€â–º OrderProducer.sendOrderEvent(orderDto, "cancelled")
      â”‚
      â–¼
KAFKA BROKER
  â”‚
  â”‚ Topic: "order_cancelled"
  â”‚
  â–¼
PRODUCT SERVICE
  â”‚
  â”œâ”€â–º @KafkaListener(topics = "order_cancelled")
  â”‚
  â””â”€â–º ProductService.increaseProductQuantity()
      â”‚
      â”œâ”€â–º Current: 48
      â”œâ”€â–º Add back: 2
      â””â”€â–º New: 50
```

**Database Update:**

```sql
UPDATE products
SET quantity = 50  -- Restored
WHERE sku_code = 'LAPTOP-001';
```

**âœ… Stock successfully restored!**

---

## ğŸ—ï¸ Architecture Patterns Used

### **1. Synchronous Communication (REST API)**

```
Order Service â”€â”€â”€â”€â”€REST APIâ”€â”€â”€â”€â–º Product Service
              â—„â”€â”€â”€â”€Responseâ”€â”€â”€â”€â”€
```

**Used for:** Product availability check

**Why:**
- âœ… Need immediate answer
- âœ… Must know before creating order
- âœ… Blocking operation required

---

### **2. Asynchronous Communication (Kafka)**

```
Order Service â”€â”€â”€Kafka Eventâ”€â”€â–º Kafka Broker
                                     â”‚
                                     â–¼
                               Product Service
                               (processes later)
```

**Used for:** Stock reduction after order

**Why:**
- âœ… User doesn't need to wait
- âœ… Better performance
- âœ… Fire and forget
- âœ… Fault tolerant

---

### **3. Event-Driven Architecture**

**Benefits:**

- ğŸ”¹ **Loose coupling**: Services are independent
- ğŸ”¹ **Scalability**: Can scale services independently
- ğŸ”¹ **Extensibility**: Easy to add new consumers
- ğŸ”¹ **Fault tolerance**: Events persist in Kafka

**Example:**

```
Order placed â”€â”€â–º Kafka â”€â”€â”¬â”€â”€â–º Product Service (reduce stock)
                         â”‚
                         â”œâ”€â”€â–º Email Service (send confirmation)
                         â”‚
                         â”œâ”€â”€â–º Analytics Service (track sales)
                         â”‚
                         â””â”€â”€â–º Warehouse Service (prepare shipment)
```

---

## âš™ï¸ Configuration Details

### **Order Service Configuration**

```yaml
# Server
server:
  port: 8082

# Database
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/orders
    
# External Services
product:
  service:
    url: http://localhost:8051/api/products

# Kafka Producer
spring:
  kafka:
    bootstrap-servers: localhost:9092
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
```

**Role:** Producer (publishes events)

---

### **Product Service Configuration**

```yaml
# Server
server:
  port: 8051

# Database
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/inventory

# Kafka Consumer
spring:
  kafka:
    bootstrap-servers: localhost:9092
    consumer:
      group-id: product-service-group
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
```

**Role:** Consumer (listens to events)

---

## ğŸš¨ Edge Cases Handled

### **Case 1: Product Not Available** âŒ

```
Scenario:
  Product in stock: 1
  User orders: 5

Flow:
  â”œâ”€â–º Availability check: available = false
  â”œâ”€â–º Order Service filters out item
  â””â”€â–º Result: "No items available" error
  
âœ… No order created
âœ… No stock reduced
```

---

### **Case 2: Multiple Products, Partial Availability** âš ï¸

```
Scenario:
  Product A: Available âœ…
  Product B: Not available âŒ

Flow:
  â”œâ”€â–º Order created with Product A only
  â”œâ”€â–º User gets partial order confirmation
  â””â”€â–º Only Product A stock reduced
  
âœ… Partial order processed
```

---

### **Case 3: Product Service Down (During Availability Check)** ğŸ”´

```
Scenario:
  Order Service calls Product Service
  â†’ No response (timeout)

Flow:
  â”œâ”€â–º ProductServiceClient catches exception
  â”œâ”€â–º Returns empty availability list
  â”œâ”€â–º Order Service: "No items available"
  â””â”€â–º User gets error message
  
âœ… Graceful failure
âœ… No corrupt data
```

---

### **Case 4: Product Service Down (During Stock Reduction)** ğŸ”„

```
Scenario:
  Order confirmed to user
  Kafka event published
  â†’ Product Service is down

Flow:
  â”œâ”€â–º Event stays in Kafka queue
  â”œâ”€â–º When Product Service restarts
  â”œâ”€â–º Processes all pending events
  â””â”€â–º Stock reduced correctly
  
âœ… Eventually consistent
âœ… No data loss
```

---

## ğŸ“Š Performance Characteristics

| Metric | Value | Description |
|--------|-------|-------------|
| **User Response Time** | ~310ms | Time to get order confirmation |
| **Stock Update Latency** | ~500ms | Time for actual stock reduction |
| **Throughput** | High | Async processing doesn't block |
| **Fault Tolerance** | Excellent | Kafka persists events |

---

## âœ… Summary

### **Why This Architecture?**

| Aspect | Benefit |
|--------|---------|
| **Fast User Experience** | Async processing = quick response |
| **Reliable** | Kafka ensures no event loss |
| **Scalable** | Services scale independently |
| **Fault Tolerant** | System survives service failures |
| **Maintainable** | Loose coupling = easy changes |

### **Key Takeaways**

1. âœ… **Availability check is SYNCHRONOUS** (must know before creating order)
2. âœ… **Stock reduction is ASYNCHRONOUS** (happens after user response)
3. âœ… **Two databases** (orders and inventory are separate)
4. âœ… **Event-driven** (Kafka enables loose coupling)
5. âœ… **Eventually consistent** (stock updates happen slightly later)

---

## ğŸ¯ Complete Flow in One Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USER   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ POST /create
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ORDER SERVICE        â”‚
â”‚  1. Check availability â”‚â”€â”€â”€â”€RESTâ”€â”€â”€â–º â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     (SYNC)             â”‚             â”‚ PRODUCT SERVICE  â”‚
â”‚                        â”‚â—„â”€â”€â”€YES/NOâ”€â”€â”€â”‚ Check DB         â”‚
â”‚  2. Filter items       â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  3. Save order         â”‚
â”‚  4. Send Kafka event   â”‚â”€â”€â”€â”€EVENTâ”€â”€â”€â–º â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     (ASYNC)            â”‚              â”‚  KAFKA BROKER    â”‚
â”‚  5. Return to user     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
     â”‚                                            â”‚
     â”‚ {"orderId": 1}                            â”‚
     â–¼                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USER   â”‚                          â”‚ PRODUCT SERVICE  â”‚
â”‚ âœ… Order â”‚                          â”‚ Reduce stock     â”‚
â”‚   placed â”‚                          â”‚ (background)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

